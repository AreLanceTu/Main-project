rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isMe(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function chatDoc(chatId) {
      return get(/databases/$(database)/documents/chats/$(chatId));
    }

    function isValidOneToOneParticipants(participants) {
      return participants is list && participants.size() == 2 &&
        participants[0] is string && participants[1] is string &&
        participants[0] != participants[1];
    }

    function jobDoc(jobId) {
      return get(/databases/$(database)/documents/job_posts/$(jobId));
    }

    // User profiles
    // - Readable by any authenticated user (so you can show name/photo in chat list)
    // - Writable only by the owner
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isMe(userId);
    }

    // Chats
    // - Only participants can read/write chat metadata
    // - Participants array is immutable after creation
    match /chats/{chatId} {
      // IMPORTANT: use resource.data here (no self-get recursion)
      allow read: if isSignedIn() && request.auth.uid in resource.data.participants;

      allow create: if isSignedIn()
        && isValidOneToOneParticipants(request.resource.data.participants)
        && request.auth.uid in request.resource.data.participants
        && request.resource.data.lastUpdated is timestamp;

      allow update: if isSignedIn()
        && request.auth.uid in resource.data.participants
        && request.resource.data.participants == resource.data.participants;

      allow delete: if false;

      // Messages within a chat
      match /messages/{messageId} {
        allow read: if isSignedIn() && request.auth.uid in chatDoc(chatId).data.participants;

        // Only the sender can create a message.
        allow create: if isSignedIn() && request.auth.uid in chatDoc(chatId).data.participants
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.receiverId in chatDoc(chatId).data.participants
          && request.resource.data.text is string
          && request.resource.data.text.size() > 0
          && request.resource.data.createdAt is timestamp
          && request.resource.data.read == false;

        // Updates allowed in two cases:
        // 1) Only the receiver can mark a message as read.
        // 2) Only the sender can "unsend" a message (mark it deleted).
        allow update: if isSignedIn() && request.auth.uid in chatDoc(chatId).data.participants
          && (
            (
              resource.data.receiverId == request.auth.uid
              && request.resource.data.senderId == resource.data.senderId
              && request.resource.data.receiverId == resource.data.receiverId
              && request.resource.data.text == resource.data.text
              && request.resource.data.createdAt == resource.data.createdAt
              && request.resource.data.read == true
            )
            ||
            (
              resource.data.senderId == request.auth.uid
              && request.resource.data.senderId == resource.data.senderId
              && request.resource.data.receiverId == resource.data.receiverId
              && request.resource.data.createdAt == resource.data.createdAt
              && request.resource.data.read == resource.data.read
              && request.resource.data.text is string
              && request.resource.data.text.size() == 0
              && request.resource.data.deleted == true
              && request.resource.data.deletedBy == request.auth.uid
              && request.resource.data.deletedAt is timestamp
              && request.resource.data.keys().hasOnly([
                'senderId', 'receiverId', 'text', 'createdAt', 'read',
                'deleted', 'deletedAt', 'deletedBy'
              ])
            )
          );

        allow delete: if false;
      }
    }

    // Job posts
    // - Readable by any authenticated user
    // - Creatable by the authenticated user as the owner
    // - Updatable/deletable only by the owner
    match /job_posts/{jobId} {
      allow read: if isSignedIn();

      allow create: if isSignedIn()
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.description is string
        && request.resource.data.budget is number;

      allow update, delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    // Job applications
    // - Each application references a jobId + applicantId
    // - Applicant can create/read their own application
    // - Job owner (client) can read applications for their jobs
    // - Updates allowed for job owner (e.g. status changes)
    match /job_applications/{applicationId} {
      allow read: if isSignedIn() && (
        resource.data.applicantId == request.auth.uid ||
        jobDoc(resource.data.jobId).data.createdBy == request.auth.uid
      );

      allow create: if isSignedIn()
        && request.resource.data.applicantId == request.auth.uid
        && request.resource.data.jobId is string
        && jobDoc(request.resource.data.jobId).data.createdBy is string;

      allow update: if isSignedIn() && (
        resource.data.applicantId == request.auth.uid ||
        jobDoc(resource.data.jobId).data.createdBy == request.auth.uid
      );

      allow delete: if false;
    }

    // Deny everything else by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
